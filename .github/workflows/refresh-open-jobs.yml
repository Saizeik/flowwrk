name: Refresh Open Jobs Feed

on:
  schedule:
    - cron: "0 0 * * *" # daily at 00:00 UTC
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest

    # IMPORTANT:
    # This must match your Environment name exactly (case-sensitive).
    # Put your Supabase secrets under Settings -> Environments -> production -> Secrets
    environment: production

    steps:
      - name: Diagnostics (safe)
        run: |
          echo "repo:  $GITHUB_REPOSITORY"
          echo "ref:   $GITHUB_REF"
          echo "sha:   $GITHUB_SHA"
          echo "event: $GITHUB_EVENT_NAME"
          echo "actor: $GITHUB_ACTOR"

      - name: Secrets visibility (safe booleans)
        env:
          HAS_FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL && 'true' || 'false' }}
          HAS_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY && 'true' || 'false' }}
          HAS_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY && 'true' || 'false' }}
        run: |
          echo "HAS_FUNCTION_URL=$HAS_FUNCTION_URL"
          echo "HAS_SERVICE_ROLE=$HAS_SERVICE_ROLE"
          echo "HAS_ANON_KEY=$HAS_ANON_KEY"

      - name: Call Supabase Edge Function
        env:
          FUNCTION_URL: ${{ secrets.SUPABASE_FUNCTION_URL }}
          SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
        run: |
          set -euo pipefail

          # Normalize/trim (handles copy/paste whitespace/newlines)
          FUNCTION_URL="$(echo -n "${FUNCTION_URL:-}" | tr -d '\r\n' | xargs)"
          SERVICE_ROLE="$(echo -n "${SERVICE_ROLE:-}" | tr -d '\r\n' | xargs)"
          ANON_KEY="$(echo -n "${ANON_KEY:-}" | tr -d '\r\n' | xargs)"

          echo "---- Secrets presence check ----"
          echo "Has FUNCTION_URL? $([[ -n "$FUNCTION_URL" ]] && echo yes || echo no)"
          echo "Has SERVICE_ROLE? $([[ -n "$SERVICE_ROLE" ]] && echo yes || echo no)"
          echo "Has ANON_KEY? $([[ -n "$ANON_KEY" ]] && echo yes || echo no)"

          if [[ -z "$FUNCTION_URL" ]]; then
            echo "❌ SUPABASE_FUNCTION_URL is empty."
            echo "➡️ Put SUPABASE_FUNCTION_URL into Settings → Environments → production → Secrets"
            exit 1
          fi

          printf 'FUNCTION_URL (bash-quoted): %q\n' "$FUNCTION_URL"
          echo "FUNCTION_URL starts with: ${FUNCTION_URL:0:80}"

          if [[ "$FUNCTION_URL" != https://* ]]; then
            echo "❌ FUNCTION_URL must start with https://"
            exit 1
          fi

          # Payload (valid JSON)
          BODY='{
            "job_titles": ["Software Engineer", "Frontend Engineer", "Customer Support", "Data Analyst", "Client Administrator"],
            "locations": ["Kirkland, WA", "Seattle, WA", "Bellevue, WA", "Redmond, WA", "Everett, WA"],
            "max_results_per_title": 25
          }'

          echo "Validating JSON payload..."
          echo "$BODY" | python -m json.tool >/dev/null

          echo "Calling Edge Function..."
          HTTP_CODE=$(curl -sS -o response.json -w "%{http_code}" -X POST "$FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SERVICE_ROLE" \
            -H "apikey: $ANON_KEY" \
            --data "$BODY")

          echo "HTTP $HTTP_CODE"
          echo "---- response.json ----"
          cat response.json || true
          echo "-----------------------"

          if [[ "$HTTP_CODE" -lt 200 || "$HTTP_CODE" -ge 300 ]]; then
            echo "❌ Edge Function call failed (HTTP $HTTP_CODE)."
            exit 1
          fi

          echo "✅ Success"
